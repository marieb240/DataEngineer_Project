{% extends "base.html" %}

{% block title %}Statistiques - VidIQ Stats{% endblock %}

{% block content %}
<div class="row mb-5">
    <div class="col-lg-12">
        <h1 class="mb-3">üìä Tableau de bord ex√©cutif</h1>
        <p class="text-muted">R√©sum√© des principaux indicateurs et analyse cl√©</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Cha√Ænes analys√©es</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ subscribers|length }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Abonn√©s max</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ subscribers|max }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Vues max</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ views|max }}</div>
        </div>
    </div>
</div>

<!-- Graphique cl√© -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Corr√©lation abonn√©s/vues</h5>
            <div id="corrChart"></div>
            <!-- La corr√©lation n'est plus affich√©e ici -->
        </div>
    </div>
</div>

<!-- Insight √©crit -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Insight cl√©</h5>
            <p>{{ interpretation }}</p>
        </div>
    </div>
</div>

<!-- Bloc 1 ‚Äî Structure du march√© -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Structure du march√©</h2>
        <p class="text-muted">Analyse de la concentration des vues sur YouTube</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Indice de Gini</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ gini }}</div>
            <small class="text-muted">{% if gini > 0.6 %}Forte concentration{% else %}Concentration mod√©r√©e{% endif %}</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Top 10</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ top10_views }}%</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Bottom 50</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ bottom50_views }}%</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Courbe de Lorenz</h5>
            <div id="lorenzChart"></div>
            <p class="mt-3">La courbe de Lorenz montre l‚Äôin√©galit√© de r√©partition des vues. Plus la courbe s‚Äô√©loigne de la diagonale, plus le march√© est concentr√©.</p>
        </div>
    </div>
</div>

<!-- Bloc 2 ‚Äî Corr√©lation abonn√©s/vues -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Corr√©lation abonn√©s/vues</h2>
        <p class="text-muted">Analyse de la relation entre la taille de l'audience et la performance des vues</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">R¬≤</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ r2|default('N/A') }}</div>
            <small class="text-muted">Force de la corr√©lation</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Performance gap</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ perf_gap|default('N/A') }}</div>
            <small class="text-muted">√âcart moyen entre pr√©dit et r√©el</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Interpr√©tation</div>
            <div class="stat-number" style="font-size:1.2rem;">{{ corr_interpretation|default('Corr√©lation non calcul√©e') }}</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Graphique de corr√©lation</h5>
            <div id="corrDetailChart"></div>
            <p class="mt-3">Ce graphique montre la relation entre abonn√©s et vues, ainsi que la droite de r√©gression.</p>
        </div>
    </div>
</div>

<!-- Bloc 3 ‚Äî Productivit√© vs performance -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Productivit√© vs performance</h2>
        <p class="text-muted">Analyse du volume de contenu publi√© et de la performance moyenne</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Productivit√© moyenne</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ productivity|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Performance moyenne</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ avg_performance|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Interpr√©tation</div>
            <div class="stat-number" style="font-size:1.2rem;">{{ productivity_interpretation|default('Non calcul√©e') }}</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Graphique productivit√©/performance</h5>
            <div id="prodPerfChart"></div>
            <p class="mt-3">Ce graphique montre la relation entre le volume de vid√©os publi√©es et la performance moyenne.</p>
        </div>
    </div>
</div>

<!-- Bloc 4 ‚Äî Efficacit√© relative -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Efficacit√© relative</h2>
        <p class="text-muted">Comparaison de l'efficacit√© des cha√Ænes (vues/abonn√©)</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Efficacit√© moyenne</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ efficiency|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Interpr√©tation</div>
            <div class="stat-number" style="font-size:1.2rem;">{{ efficiency_interpretation|default('Non calcul√©e') }}</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Graphique efficacit√©</h5>
            <div id="efficiencyChart"></div>
            <p class="mt-3">Ce graphique compare l'efficacit√© relative des cha√Ænes.</p>
        </div>
    </div>
</div>

<!-- Bloc 5 ‚Äî Segmentation avanc√©e -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Segmentation avanc√©e</h2>
        <p class="text-muted">Analyse par segments (cat√©gories, clusters, etc.)</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Statistiques par segment</div>
            <div class="stat-number" style="font-size:1.2rem;">{{ segments_stats|default('Non calcul√©es') }}</div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Interpr√©tation</div>
            <div class="stat-number" style="font-size:1.2rem;">{{ segments_interpretation|default('Non calcul√©e') }}</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5>Graphique segmentation</h5>
            <div id="segmentsChart"></div>
            <p class="mt-3">Ce graphique montre la dispersion des performances par segment.</p>
        </div>
    </div>
</div>

<!-- Bloc 6 ‚Äî Indicateurs de dispersion -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Indicateurs de dispersion</h2>
        <p class="text-muted">Analyse de la variabilit√© des vues et abonn√©s</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">√âcart-type vues</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ std_views|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">√âcart-type abonn√©s</div>
            <div class="stat-number" style="font-size:2.5rem;">{{ std_subscribers|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Interpr√©tation</div>
            <div class="stat-number" style="font-size:1.2rem;">{{ dispersion_interpretation|default('Non calcul√©e') }}</div>
        </div>
    </div>
</div>

<!-- Bloc 7 ‚Äî Synth√®se et implications strat√©giques -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2>Synth√®se & implications strat√©giques</h2>
        <p class="text-muted">R√©sum√© des principaux enseignements et recommandations</p>
        <div class="card-dark p-4">
            <div class="stat-number" style="font-size:1.2rem;">{{ synthese|default('Synth√®se non disponible') }}</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
var subscribers = JSON.parse('{{ subscribers | tojson | safe }}');
var views = JSON.parse('{{ views | tojson | safe }}');
var segments = JSON.parse('{{ segments | tojson | safe }}');
var names = JSON.parse('{{ names | tojson | safe }}');
var channels = JSON.parse('{{ channels | tojson | safe }}');
var videos = JSON.parse('{{ videos | tojson | safe }}');

// Corr√©lation abonn√©s/vues
Plotly.newPlot('corrChart', [{
    x: subscribers,
    y: views,
    mode: 'markers',
    text: names,
    marker: {size: 8, color: '#ef4444', opacity: 0.7}
}], {
    template: 'plotly_dark',
    xaxis: {title: 'Abonn√©s'},
    yaxis: {title: 'Vues'},
    hovermode: 'closest'
});

var x_lorenz = JSON.parse('{{ x_lorenz | tojson | safe }}');
var y_lorenz = JSON.parse('{{ y_lorenz | tojson | safe }}');
// Lorenz
Plotly.newPlot('lorenzChart', [
    {
        x: x_lorenz,
        y: y_lorenz,
        mode: 'lines+markers',
        name: 'Lorenz',
        line: {color: '#ef4444', width: 3}
    },
    {
        x: x_lorenz,
        y: x_lorenz,
        mode: 'lines',
        name: '√âgalit√© parfaite',
        line: {color: '#3b82f6', dash: 'dot'}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Part des cha√Ænes'},
    yaxis: {title: 'Part des vues'},
    legend: {orientation: 'h'},
    height: 350
});

// Variables analytiques inject√©es depuis Flask
var r2 = JSON.parse('{{ r2|tojson|safe }}');
var perf_gap = JSON.parse('{{ perf_gap|tojson|safe }}');
var productivity = JSON.parse('{{ productivity|tojson|safe }}');
var avg_performance = JSON.parse('{{ avg_performance|tojson|safe }}');
var efficiency = JSON.parse('{{ efficiency|tojson|safe }}');
var segments_stats = JSON.parse('{{ segments_stats|tojson|safe }}');
var std_views = JSON.parse('{{ std_views|tojson|safe }}');
var std_subscribers = JSON.parse('{{ std_subscribers|tojson|safe }}');

// Graphiques avanc√©s
Plotly.newPlot('corrDetailChart', [
    {
        x: subscribers,
        y: views,
        mode: 'markers',
        name: 'Cha√Ænes',
        marker: {size: 8, color: '#ef4444', opacity: 0.7}
    },
    {
        x: subscribers,
        y: perf_gap,
        mode: 'lines',
        name: 'R√©gression',
        line: {color: '#3b82f6', width: 2}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Abonn√©s'},
    yaxis: {title: 'Vues'},
    legend: {orientation: 'h'},
    height: 350
});

Plotly.newPlot('prodPerfChart', [
    {
        x: productivity,
        y: avg_performance,
        mode: 'markers',
        name: 'Cha√Ænes',
        marker: {size: 8, color: '#10b981', opacity: 0.7}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Productivit√©'},
    yaxis: {title: 'Performance moyenne'},
    legend: {orientation: 'h'},
    height: 350
});

Plotly.newPlot('efficiencyChart', [
    {
        x: names,
        y: efficiency,
        mode: 'markers',
        name: 'Efficacit√©',
        marker: {size: 8, color: '#f59e42', opacity: 0.7}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Cha√Æne'},
    yaxis: {title: 'Efficacit√© (vues/abonn√©)'},
    legend: {orientation: 'h'},
    height: 350
});

Plotly.newPlot('segmentsChart', [
    {
        x: segments,
        y: views,
        mode: 'markers',
        name: 'Segments',
        marker: {size: 8, color: '#6366f1', opacity: 0.7}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Segment'},
    yaxis: {title: 'Vues'},
    legend: {orientation: 'h'},
    height: 350
});

// ===================== Graphique Corr√©lation analytique =====================
// Palette segments am√©lior√©e (gradient vert -> rouge)
var segmentColors = {
    'Micro': '#2ecc40', // vert
    'Mid': '#3b82f6',  // bleu
    'Large': '#f59e42', // orange
    'Mega': '#ef4444'  // rouge
};
var segmentLabels = {
    'Micro': 'üü¢ Micro',
    'Mid': 'üîµ Mid',
    'Large': 'üü† Large',
    'Mega': 'üî¥ Mega (> Q3)'
};

function linearRegression(x, y) {
    var n = x.length;
    var xMean = x.reduce((a, b) => a + b, 0) / n;
    var yMean = y.reduce((a, b) => a + b, 0) / n;
    var num = 0, den = 0;
    for (var i = 0; i < n; i++) {
        num += (x[i] - xMean) * (y[i] - yMean);
        den += (x[i] - xMean) ** 2;
    }
    var slope = num / den;
    var intercept = yMean - slope * xMean;
    var ssTot = 0, ssRes = 0;
    for (var i = 0; i < n; i++) {
        var yPred = slope * x[i] + intercept;
        ssTot += (y[i] - yMean) ** 2;
        ssRes += (y[i] - yPred) ** 2;
    }
    var r2 = 1 - ssRes / ssTot;
    return { slope, intercept, r2 };
}

function log10Array(arr) {
    return arr.map(function(v) { return Math.log10(v > 0 ? v : 1); });
}

var x = subscribers;
var y = views;
var segmentList = segments;
var videoCounts = videos;
var namesList = names;

var xLog = log10Array(x);
var yLog = log10Array(y);

var reg = linearRegression(xLog, yLog);
var yReg = xLog.map(function(xv) { return reg.slope * xv + reg.intercept; });
var yRegExp = yReg.map(function(v) { return Math.pow(10, v); });

// Performance gap (√©cart √† la droite)
var perfGap = yLog.map(function(v, i) { return v - yReg[i]; });

// Palette segments (couleurs vives, style analytique)
var segmentColors = {
    'Micro': '#10b981', // vert
    'Mid': '#6366f1',  // bleu
    'Large': '#f59e42', // orange
    'Mega': '#ef4444'  // rouge
};
var segmentLabels = {
    'Micro': 'üü¢ Micro',
    'Mid': 'üîµ Mid',
    'Large': 'üü† Large',
    'Mega': 'üî¥ Mega'
};

// Taille born√©e des points (encore plus petit)
var pointSizes = videoCounts.map(function(v) { return Math.max(3, Math.min(10, Math.sqrt(v) * 0.9)); });

// Traces par segment pour l√©gende explicite
var traces = [];
['Micro','Mid','Large','Mega'].forEach(function(seg) {
    var idx = segmentList.map(function(s) { return s === seg; });
    var xSeg = x.filter(function(_,i){return idx[i];});
    var ySeg = y.filter(function(_,i){return idx[i];});
    var namesSeg = namesList.filter(function(_,i){return idx[i];});
    var sizeSeg = pointSizes.filter(function(_,i){return idx[i];});
    traces.push({
        x: xSeg,
        y: ySeg,
        text: namesSeg,
        name: segmentLabels[seg],
        mode: 'markers',
        type: 'scatter',
        marker: {
            size: sizeSeg,
            color: segmentColors[seg],
            opacity: 0.7,
            line: { color: '#fff', width: 1 }
        },
        hovertemplate: '<b>%{text}</b><br>Abonn√©s: %{x}<br>Vues: %{y}<br>Vid√©os: %{marker.size}<extra></extra>'
    });
});

// R√©gression globale
var traceRegression = {
    x: x,
    y: yRegExp,
    mode: 'lines',
    name: 'R√©gression log-log (y = ' + reg.slope.toFixed(2) + ' log(x) + ' + reg.intercept.toFixed(2) + ')',
    line: { color: '#fff', width: 2, dash: 'dot' },
    showlegend: true
};

// Outliers >2 √©carts-types
var stdGap = Math.sqrt(perfGap.reduce(function(a,b){return a+(b-reg.r2)**2;},0)/perfGap.length);
var outlierIdx = perfGap.map(function(gap,i){return Math.abs(gap)>2*stdGap?i:null;}).filter(x=>x!==null);

// Annotations outliers
var annotations = [];
outlierIdx.forEach(function(i) {
    annotations.push({
        x: x[i], y: y[i], xref: 'x', yref: 'y',
        text: 'Outlier: ' + namesList[i],
        showarrow: true, arrowcolor: '#fff', arrowwidth: 2,
        font: { color: '#fff', size: 11 },
        ax: 0, ay: -40, bgcolor: '#ef4444', bordercolor: '#fff', borderpad: 3
    });
});

// L√©gende custom pour la taille
var customLegend = document.createElement('div');
customLegend.className = 'mt-2 mb-2';
customLegend.innerHTML = '<span style="color:#fff;font-size:0.9em">Taille = Nombre de vid√©os publi√©es</span>';
document.getElementById('corrDetailChart').parentNode.insertBefore(customLegend, document.getElementById('corrDetailChart'));

var layoutCorr = {
    template: 'plotly_dark',
    xaxis: { title: 'Abonn√©s (log)', type: 'log', color: '#fff', gridcolor: '#333', tickformat: '.2s' },
    yaxis: { title: 'Vues (log)', type: 'log', color: '#fff', gridcolor: '#333', tickformat: '.2s' },
    legend: { orientation: 'h', font: { color: '#fff' } },
    height: 520,
    plot_bgcolor: '#181e2a',
    paper_bgcolor: '#181e2a',
    margin: { l: 60, r: 30, t: 40, b: 60 },
    annotations: [
        {
            x: Math.max.apply(null, x),
            y: Math.max.apply(null, y),
            xref: 'x', yref: 'y',
            text: 'R¬≤ = ' + (reg.r2).toFixed(2),
            showarrow: false,
            font: { color: '#fff', size: 14 },
            bgcolor: '#222', bordercolor: '#fff', borderpad: 3
        }
    ].concat(annotations)
};

if (document.getElementById('corrDetailChart')) {
    Plotly.purge('corrDetailChart');
}
Plotly.newPlot('corrDetailChart', traces.concat([traceRegression]), layoutCorr);
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Palette modifi√©e : texte gris devient blanc */
.stat-label {
    color: #fff !important;
    font-size: 0.9rem;
    text-transform: uppercase;
}
.text-muted {
    color: #fff !important;
}
.card-dark .stat-number, .card-dark small {
    color: #fff !important;
}

/* Ajout : les nombres dans .stat-number redeviennent rouges */
.card-dark .stat-number {
    color: #ef4444 !important;
}
</style>
{% endblock %}