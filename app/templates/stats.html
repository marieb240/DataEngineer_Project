{% extends "base.html" %}

{% block title %}Statistiques - VidIQ Stats{% endblock %}

{% block content %}
<!-- ===================== üü¢ SECTION 1 : PERFORMANCE & MON√âTISATION ===================== -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2 class="mt-4 mb-2 kpi-performance">üü¢ Performance & Mon√©tisation</h2>
        <p class="text-muted">Indicateurs business cl√©s : revenu estim√©, efficacit√©, top 10.</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Revenu total estim√©</div>
            <div class="stat-number kpi-performance">{{ revenue_total|humanize_metric }} ‚Ç¨</div>
            <div class="stat-context">Somme estim√©e des revenus g√©n√©r√©s par toutes les cha√Ænes (calcul bas√© sur RPM = 3‚Ç¨ pour 1000 vues).</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Revenu moyen par cha√Æne</div>
            <div class="stat-number kpi-performance">{{ revenue_mean|humanize_metric }} ‚Ç¨</div>
            <div class="stat-context">Revenu moyen g√©n√©r√© par une cha√Æne (moyenne sur l'ensemble du panel).</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Revenu max</div>
            <div class="stat-number kpi-performance">{{ revenue_max|humanize_metric }} ‚Ç¨</div>
            <div class="stat-context">Revenu estim√© de la cha√Æne la plus performante.</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark p-4 mb-3">
            <h5 class="kpi-performance">Top 10 revenus</h5>
            <div id="top10RevenueChart"></div>
            <div class="stat-context" style="margin-top:8px; color:#b0b0b0;">
Ce graphique pr√©sente les cha√Ænes g√©n√©rant le plus de revenus estim√©s, calcul√©s sur la base des vues totales et d'un RPM business. Un indicateur cl√© pour visualiser la mon√©tisation maximale du march√©.
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark p-4 mb-3">
            <h5 class="kpi-efficiency">Top 10 efficacit√© (views/video)</h5>
            <div id="top10EfficiencyChart"></div>
            <div class="stat-context" style="margin-top:8px; color:#b0b0b0;">
Ce graphique met en avant les cha√Ænes les plus efficaces : celles qui g√©n√®rent le plus de vues par vid√©o publi√©e. Un indicateur cl√© pour identifier les cr√©ateurs √† fort impact, ind√©pendamment du volume de contenu.
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark p-4 mb-3">
            <h5 class="kpi-performance">Scatter : vid√©os vs revenu par vid√©o</h5>
            <div id="videoRevenueScatter"></div>
        </div>
    </div>
</div>

<!-- ===================== üîµ SECTION 2 : AUDIENCE ===================== -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2 class="mt-4 mb-2 kpi-audience">üîµ Audience</h2>
        <p class="text-muted">Indicateurs d‚Äôaudience : abonn√©s, vues, distribution.</p>
    </div>
</div>
<div class="row mb-4" style="background:#f8fafc; border-radius:12px;">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Abonn√©s max</div>
            <div class="stat-number kpi-audience">{{ (subscribers|max/1000000)|round|int }}M</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Distribution abonn√©s</div>
            <div class="stat-number kpi-audience">{{ distribution_subscribers|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Vues max</div>
            <div class="stat-number kpi-audience">{{ (views|max/1000000000)|round|int }}B</div>
        </div>
    </div>
</div>
<div class="row mb-4" style="background:#f8fafc; border-radius:12px;">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5 class="kpi-audience">Scatter abonn√©s vs vues</h5>
            <div id="audienceScatter"></div>
        </div>
    </div>
</div>

<!-- ===================== üü£ SECTION 3 : ANALYSE AVANC√âE ===================== -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2 class="mt-4 mb-2 kpi-structure">üü£ Analyse avanc√©e ‚Äì Structure du march√©</h2>
        <p class="text-muted">üî¨ Structure du march√© et rendements (corr√©lations log-log, Lorenz, Gini, R¬≤, MAE)</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5 class="kpi-structure">Courbe de Lorenz</h5>
            <div id="lorenzChart"></div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Corr√©lation log-log</div>
            <div class="stat-number kpi-structure">{{ corr_disp|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">R¬≤</div>
            <div class="stat-number kpi-structure">{{ r2_disp|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">MAE</div>
            <div class="stat-number kpi-structure">{{ mae_log|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Gini</div>
            <div class="stat-number kpi-structure">{{ gini_disp|default('N/A') }}</div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// ===================== BUSINESS CHARTS =====================
var top10Revenue = JSON.parse('{{ top10_revenue | tojson | safe }}');
var revenues = top10Revenue.map(x => x.revenue);
Plotly.newPlot('top10RevenueChart', [
    {
        y: top10Revenue.map(x => x.channel_name),
        x: revenues,
        type: 'bar',
        orientation: 'h',
        marker: {color: 'var(--color-performance)'},
        text: revenues.map(r => (r/1e6).toFixed(1) + "M"),
        textposition: "outside",
        textfont: {color: '#fff', size: 18, family: 'Inter'},
        name: 'Revenu estim√©',
    }
], {
    template: 'plotly_dark',
    yaxis: {
        title: '', // Supprime le titre pour √©viter le chevauchement
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        automargin: true,
    },
    xaxis: {
        title: 'Revenu (‚Ç¨)',
        color: '#fff',
        tickformat: ',.0f',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...revenues) * 1.5], // √©tend l'axe X pour des barres tr√®s longues
    },
    margin: {l: 120, r: 30, t: 40, b: 60},
    height: 380,
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)"
}, {displayModeBar: false});
var top10Efficiency = JSON.parse('{{ top10_efficiency | tojson | safe }}');
var efficiencies = top10Efficiency.map(x => x.efficiency);
Plotly.newPlot('top10EfficiencyChart', [
    {
        y: top10Efficiency.map(x => x.channel_name),
        x: efficiencies,
        type: 'bar',
        orientation: 'h',
        marker: {color: 'var(--color-efficiency)'},
        text: efficiencies.map(e => (e/1e6).toFixed(1) + "M"),
        textposition: "outside",
        textfont: {color: '#fff', size: 18, family: 'Inter'},
        name: 'Efficacit√© (vues/vid√©o)',
    }
], {
    template: 'plotly_dark',
    yaxis: {
        title: '',
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        automargin: true,
    },
    xaxis: {
        title: 'Efficacit√© (vues/vid√©o)',
        color: '#fff',
        tickformat: ',.0f',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...efficiencies) * 1.5], // √©tend encore plus l'axe X pour des barres tr√®s longues
    },
    margin: {l: 120, r: 30, t: 40, b: 60},
    height: 380,
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)"
}, {displayModeBar: false});
var videos_list = JSON.parse('{{ videos_list | tojson | safe }}');
var revenue_per_video_list = JSON.parse('{{ revenue_per_video_list | tojson | safe }}');
var names = JSON.parse('{{ names | tojson | safe }}');
Plotly.newPlot('videoRevenueScatter', [
    {
        x: videos_list,
        y: revenue_per_video_list,
        mode: 'markers',
        text: names,
        marker: {
            size: 14,
            color: 'var(--color-performance)',
            opacity: 0.85,
            line: {width: 1, color: '#fff'}
        }
    }
], {
    template: 'plotly_dark',
    xaxis: {
        title: 'Vid√©os publi√©es',
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...videos_list) * 1.1],
    },
    yaxis: {
        title: 'Revenu par vid√©o (‚Ç¨)',
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...revenue_per_video_list) * 1.1],
    },
    margin: {l: 60, r: 30, t: 40, b: 60},
    height: 420,
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)"
}, {displayModeBar: false});
// ===================== AUDIENCE CHARTS =====================
var subscribers = JSON.parse('{{ subscribers | tojson | safe }}');
var views = JSON.parse('{{ views | tojson | safe }}');
Plotly.newPlot('audienceScatter', [
    {
        x: subscribers,
        y: views,
        mode: 'markers',
        text: names,
        marker: {size: 6, color: 'var(--color-audience)', opacity: 0.7}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Abonn√©s', color: '#fff', showgrid: false},
    yaxis: {title: 'Vues', color: '#fff', showgrid: false},
    height: 320
});
// ===================== ANALYSE AVANC√âE =====================
var x_lorenz = JSON.parse('{{ x_lorenz | tojson | safe }}');
var y_lorenz = JSON.parse('{{ y_lorenz | tojson | safe }}');
Plotly.newPlot('lorenzChart', [
    {
        x: x_lorenz,
        y: y_lorenz,
        mode: 'lines+markers',
        name: 'Lorenz',
        line: {color: 'var(--color-structure)', width: 3},
        marker: {size: 6, color: 'var(--color-structure)'}
    },
    {
        x: x_lorenz,
        y: x_lorenz,
        mode: 'lines',
        name: '√âgalit√© parfaite',
        line: {color: '#b0b0b0', dash: 'dot'}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Part des cha√Ænes', color: '#fff', showgrid: false},
    yaxis: {title: 'Part des vues', color: '#fff', showgrid: false},
    legend: {orientation: 'h'},
    height: 350
});
</script>
{% endblock extra_js %}