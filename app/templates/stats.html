{% extends "base.html" %}

{% block title %}Statistiques - VidIQ Stats{% endblock %}

{% block content %}
<!-- SECTION 1 : PERFORMANCE & MONÉTISATION -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2 class="mt-4 mb-2 kpi-performance"> Performance & Monétisation</h2>
        <p class="text-muted">Indicateurs business clés : revenu estimé, efficacité, top 10.</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Revenu total estimé</div>
            <div class="stat-number kpi-performance">{{ revenue_total|humanize_metric }} €</div>
            <div class="stat-context">Somme estimée des revenus générés par toutes les chaînes (calcul basé sur RPM = 3€ pour 1000 vues).</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Revenu moyen par chaîne</div>
            <div class="stat-number kpi-performance">{{ revenue_mean|humanize_metric }} €</div>
            <div class="stat-context">Revenu moyen généré par une chaîne (moyenne sur l'ensemble du panel).</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Revenu max</div>
            <div class="stat-number kpi-performance">{{ revenue_max|humanize_metric }} €</div>
            <div class="stat-context">Revenu estimé de la chaîne la plus performante.</div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark p-4 mb-3">
            <h5 class="kpi-performance">Top 10 revenus</h5>
            <div id="top10RevenueChart"></div>
            <div class="stat-context" style="margin-top:8px; color:#b0b0b0;">
Ce graphique présente les chaînes générant le plus de revenus estimés, calculés sur la base des vues totales et d'un RPM business. Un indicateur clé pour visualiser la monétisation maximale du marché.
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark p-4 mb-3">
            <h5 class="kpi-efficiency">Top 10 efficacité (views/video)</h5>
            <div id="top10EfficiencyChart"></div>
            <div class="stat-context" style="margin-top:8px; color:#b0b0b0;">
Ce graphique met en avant les chaînes les plus efficaces : celles qui génèrent le plus de vues par vidéo publiée. Un indicateur clé pour identifier les créateurs à fort impact, indépendamment du volume de contenu.
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark p-4 mb-3">
            <h5 class="kpi-performance">Scatter : vidéos vs revenu par vidéo</h5>
            <div id="videoRevenueScatter"></div>
        </div>
    </div>
</div>

<!-- SECTION 2 : AUDIENCE -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2 class="mt-4 mb-2 kpi-audience"> Audience</h2>
        <p class="text-muted">Indicateurs d’audience : abonnés, vues, distribution.</p>
    </div>
</div>
<div class="row mb-4" style="background:#f8fafc; border-radius:12px;">
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Abonnés max</div>
            <div class="stat-number kpi-audience">{{ (subscribers|max/1000000)|round|int }}M</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Distribution abonnés</div>
            <div class="stat-number kpi-audience">{{ distribution_subscribers|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Vues max</div>
            <div class="stat-number kpi-audience">{{ (views|max/1000000000)|round|int }}B</div>
        </div>
    </div>
</div>
<div class="row mb-4" style="background:#f8fafc; border-radius:12px;">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5 class="kpi-audience">Scatter abonnés vs vues</h5>
            <div id="audienceScatter"></div>
        </div>
    </div>
</div>

<!-- SECTION 3 : ANALYSE AVANCÉE -->
<div class="row mb-5">
    <div class="col-lg-12">
        <h2 class="mt-4 mb-2 kpi-structure"> Analyse avancée – Structure du marché</h2>
        <p class="text-muted"> Structure du marché et rendements (corrélations log-log, Lorenz, Gini, R², MAE)</p>
    </div>
</div>
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card-dark">
            <h5 class="kpi-structure">Courbe de Lorenz</h5>
            <div id="lorenzChart"></div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Corrélation log-log</div>
            <div class="stat-number kpi-structure">{{ corr_disp|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">R²</div>
            <div class="stat-number kpi-structure">{{ r2_disp|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">MAE</div>
            <div class="stat-number kpi-structure">{{ mae_log|default('N/A') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-dark text-center p-4 mb-3">
            <div class="stat-label">Gini</div>
            <div class="stat-number kpi-structure">{{ gini_disp|default('N/A') }}</div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// SECTION 1 : PERFORMANCE & MONÉTISATION
var top10Revenue = JSON.parse('{{ top10_revenue | tojson | safe }}');
var revenues = top10Revenue.map(x => x.revenue);
Plotly.newPlot('top10RevenueChart', [
    {
        y: top10Revenue.map(x => x.channel_name),
        x: revenues,
        type: 'bar',
        orientation: 'h',
        marker: {color: 'var(--color-performance)'},
        text: revenues.map(r => (r/1e6).toFixed(1) + "M"),
        textposition: "outside",
        textfont: {color: '#fff', size: 18, family: 'Inter'},
        channel_name: 'Revenu estimé',
    }
], {
    template: 'plotly_dark',
    yaxis: {
        title: '', // Supprime le titre pour éviter le chevauchement
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        automargin: true,
    },
    xaxis: {
        title: 'Revenu (€)',
        color: '#fff',
        tickformat: ',.0f',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...revenues) * 1.5], // étend l'axe X pour des barres très longues
    },
    margin: {l: 120, r: 30, t: 40, b: 60},
    height: 380,
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)"
}, {displayModeBar: false});
var top10Efficiency = JSON.parse('{{ top10_efficiency | tojson | safe }}');
var efficiencies = top10Efficiency.map(x => x.efficiency);
Plotly.newPlot('top10EfficiencyChart', [
    {
        y: top10Efficiency.map(x => x.channel_name),
        x: efficiencies,
        type: 'bar',
        orientation: 'h',
        marker: {color: 'var(--color-efficiency)'},
        text: efficiencies.map(e => (e/1e6).toFixed(1) + "M"),
        textposition: "outside",
        textfont: {color: '#fff', size: 18, family: 'Inter'},
        channel_name: 'Efficacité (vues/vidéo)',
    }
], {
    template: 'plotly_dark',
    yaxis: {
        title: '',
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        automargin: true,
    },
    xaxis: {
        title: 'Efficacité (vues/vidéo)',
        color: '#fff',
        tickformat: ',.0f',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...efficiencies) * 1.5], // étend encore plus l'axe X pour des barres très longues
    },
    margin: {l: 120, r: 30, t: 40, b: 60},
    height: 380,
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)"
}, {displayModeBar: false});
var videos_list = JSON.parse('{{ videos_list | tojson | safe }}');
var revenue_per_video_list = JSON.parse('{{ revenue_per_video_list | tojson | safe }}');
var channel_name = JSON.parse('{{ channel_name | tojson | safe }}');
Plotly.newPlot('videoRevenueScatter', [
    {
        x: videos_list,
        y: revenue_per_video_list,
        mode: 'markers',
        text: channel_name,
        marker: {
            size: 14,
            color: 'var(--color-performance)',
            opacity: 0.85,
            line: {width: 1, color: '#fff'}
        }
    }
], {
    template: 'plotly_dark',
    xaxis: {
        title: 'Vidéos publiées',
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...videos_list) * 1.1],
    },
    yaxis: {
        title: 'Revenu par vidéo (€)',
        color: '#fff',
        showgrid: false,
        tickfont: {color: '#fff', size: 16, family: 'Inter'},
        range: [0, Math.max(...revenue_per_video_list) * 1.1],
    },
    margin: {l: 60, r: 30, t: 40, b: 60},
    height: 420,
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)"
}, {displayModeBar: false});
// SECTION 2 : AUDIENCE
var subscribers = JSON.parse('{{ subscribers | tojson | safe }}');
var views = JSON.parse('{{ views | tojson | safe }}');
Plotly.newPlot('audienceScatter', [
    {
        x: subscribers,
        y: views,
        mode: 'markers',
        text: channel_name,
        marker: {size: 6, color: 'var(--color-audience)', opacity: 0.7}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Abonnés', color: '#fff', showgrid: false},
    yaxis: {title: 'Vues', color: '#fff', showgrid: false},
    height: 320
});
// ANALYSE AVANCÉE 
var x_lorenz = JSON.parse('{{ x_lorenz | tojson | safe }}');
var y_lorenz = JSON.parse('{{ y_lorenz | tojson | safe }}');
Plotly.newPlot('lorenzChart', [
    {
        x: x_lorenz,
        y: y_lorenz,
        mode: 'lines+markers',
        channel_name: 'Lorenz',
        line: {color: 'var(--color-structure)', width: 3},
        marker: {size: 6, color: 'var(--color-structure)'}
    },
    {
        x: x_lorenz,
        y: x_lorenz,
        mode: 'lines',
        channel_name: 'Égalité parfaite',
        line: {color: '#b0b0b0', dash: 'dot'}
    }
], {
    template: 'plotly_dark',
    xaxis: {title: 'Part des chaînes', color: '#fff', showgrid: false},
    yaxis: {title: 'Part des vues', color: '#fff', showgrid: false},
    legend: {orientation: 'h'},
    height: 350
});
</script>
{% endblock extra_js %}